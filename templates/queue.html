{% extends 'base.html' %} {% block scripts %}
<!-- <meta http-equiv="refresh" content="5" /> -->

<script>
  var queue = [];  
  var previousQueue = [];

  function getQueue() {
    $.get('{{ url_for("get_queue") }}', function (data) {
      newQueue =  JSON.parse(data);
      if (!_.isEqual(newQueue, previousQueue)) {
        queue = newQueue;
        $("#auto-refresh").html(generateQueueHTML());
        previousQueue = newQueue;
      }
    })
  }

  function generateQueueHTML() {
    var html = "";
    if (queue.length > 0) {
      queue.forEach((e, index) => {
        html += `
          <tr value=${e.title}>
            <td width="20px" style="padding: 5px 0px">${index + 1}</td>
            {% if admin %}
              <td width="20px" style="padding: 5px 0px">
                <a
                  class="up-button"
                  href="/queue/edit?action=up&song=${encodeURIComponent(e.file)}"
                  title="Move up in queue"
                  ><i class="icon  icon-up-circled ${index == 0 && "is-hidden"}"></i>
                </a>
              </td>
              <td width="20px" style="padding: 5px 0px">
                <a
                  class="down-button"
                  href="/queue/edit?action=down&song=${encodeURIComponent(e.file)}"
                  title="Move down in queue"
                  ><i class="icon  icon-down-circled ${index + 1 == queue.length && "is-hidden"}"></i>
                </a>
              </td>
            {% endif %}
            <td style="padding-left: 10px" class="is-hidden-mobile has-text-success"><b>${e.user}</b></td>
            <td style="padding-left: 5px"><b class="is-hidden-tablet has-text-success">${e.user}: </b> ${e.title}</td>
            {% if admin %}
              <td width="20px">
                <a
                  class="delete-button confirm-delete has-text-danger"
                  title="Delete from queue"
                  href="/queue/edit?action=delete&song=${encodeURIComponent(e.file)}"
                  ><i class="icon icon-trash-empty"></i>
                </a>
              </td>
            {% endif %}
          </tr>
        `
      });
    }
    else {
      console.log("empty")
      html += "<tr>The queue is empty</tr>"
    }
    return html;
  }

  $(function () {
    $(".confirm-delete").click(function (e) {
      e.preventDefault();
      if (
        window.confirm(
          "Are you sure you want to delete this song from the queue?"
        )
      ) {
        location.href = this.href;
      }
    });
    $(".confirm-clear").click(function (e) {
      e.preventDefault();
      let prompt = window.prompt(
        "Are you sure you want to clear the ENTIRE queue? Type 'OK' to continue"
      );
      if (prompt.toLowerCase() === "ok") {
        location.href = this.href;
      }
    });

    // hide queue controls for first track
    $(".up-button").first().hide();

    // hide down button for last track
    $(".down-button").last().hide();

    getQueue();
    
    var previousQueue;
    setInterval(function() {
        getQueue();
      },
      5000
    )
  });
</script>

{% endblock %} 

{% block header %}
<h1 class>{% block title %}Queue{% endblock %}</h1>
{% endblock %} 

{% block content %} 

<table id="auto-refresh">
</table>
<hr />

{% if admin %}
<a class="add-random has-text-success" href="/queue/addrandom?amount=3"
  ><i class="icon  icon-plus-circled"></i>Add 3 random songs</a
>
<a
  class="confirm-clear has-text-danger is-pulled-right"
  href="/queue/edit?action=clear"
  ><i class="icon icon-trash-empty"></i> Clear all</a
><br />
{% endif %}

{% endblock %}
