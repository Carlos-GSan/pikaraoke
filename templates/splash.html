{% extends 'base.html' %} {% block scripts %}
<script>
  var mouseTimer = null,
    cursorVisible = true;

  var isPlaying = false;
  var isPaused = false;
  var nowPlayingInterval = null;
  var nowPlayingHash = null;

  function startNowPlayingPolling() {
    nowPlayingInterval = setInterval(getNowPlaying, 1000);
  }

  function handleConfirmation() {
    $("#permissions-modal").removeClass("is-active");
  }

  function clearCommand() {
    $.get('{{ url_for("clear_command") }}');
  }

  function endSong() {
    $("#video-container").hide();
    $.get('{{ url_for("end_song") }}');
    setTimeout(() => (isPlaying = false), 1100);
  }

  function executeCommand(callback) {
    callback();
    clearCommand();
    setTimeout(() => getNowPlaying(), 100);
  }

  function getNowPlaying() {
    $.get('{{ url_for("nowplaying") }}', function (data) {
      var obj = JSON.parse(data);
      if (obj.hash != nowPlayingHash) {
        nowPlayingHash = obj.hash;
        console.log(obj);

        // render the queue details in top right
        if (obj.up_next) {
          // {# MSG: Label for the next song to be played in the queue. #}
          up_next_text = "{{ _('Up next:') }}";
          // {# MSG: Label of the singer for next song to be played in the queue. (Who added it to the queue.) #}
          next_singer_text = "{{ _('Next singer:') }}";
          $("#up-next-top").html(`
           <b class="has-text-white">${up_next_text} </b>${obj.up_next}`);
          $("#up-next-bottom").html(
            `<b class="has-text-white">${next_singer_text} </b><i class="icon icon-mic-1" title="Next singer"></i>${obj.next_user}`
          );
        } else {
          $("#up-next-top").html(
            // {# MSG: Message when the queue of songs is empty.  Shown instead of what the next song is. #}
            `<span class="has-text-warning">{{ _('No song is queued.') }}</span>`
          );
          $("#up-next-bottom").html("");
        }

        const video = $("#video")[0];

        // Start playback if a valid now_playing_url is provided
        if (obj.now_playing_url && !isPlaying) {
          isPlaying = true;
          $("#video-source").attr("src", obj.now_playing_url);
          video.load();
          video.play();
        }

        // Handle vol up
        if (obj.now_playing_command == "vol_up" && isPlaying) {
          executeCommand(() => {
            const volume = video.volume;
            video.volume = Math.min(1, volume + 0.1);
          });
        }

        // Handle vol down
        if (obj.now_playing_command == "vol_down" && isPlaying) {
          executeCommand(() => {
            const volume = video.volume;
            video.volume = Math.max(0, volume - 0.1);
          });
        }

        // Handle pause
        if (obj.now_playing_command == "pause" && isPlaying) {
          executeCommand(() => {
            isPaused ? video.play() : video.pause();
            isPaused = !isPaused;
          });
        }

        // Handle skip
        if (obj.now_playing_command == "skip" && isPlaying) {
          executeCommand(() => {
            video.pause();
            endSong();
          });
        }

        // Handle restart
        if (obj.now_playing_command == "restart" && isPlaying) {
          executeCommand(() => {
            video.currentTime = 0;
          });
        }
      }
    });
  }

  $(function () {
    $("#video-container").hide();
    startNowPlayingPolling();

    //hide mouse cursor after 2 seconds of inactivity
    document.onmousemove = function () {
      if (mouseTimer) {
        window.clearTimeout(mouseTimer);
      }
      if (!cursorVisible) {
        document.body.style.cursor = "default";
        cursorVisible = true;
      }
      mouseTimer = window.setTimeout(() => {
        mouseTimer = null;
        document.body.style.cursor = "none";
        cursorVisible = false;
      }, 2000);
    };

    //Video status events for communicating state back to server
    $("#video")[0].addEventListener("play", () => {
      $("#video-container").show();
      $.get('{{ url_for("start_song") }}');
    });
    $("#video")[0].addEventListener("ended", () => {
      endSong();
    });

    //make sure we end the song if the user closes the window or leaves page
    window.addEventListener("beforeunload", function (event) {
      endSong();
    });
  });
</script>
{% endblock %} {% block body %}
<div id="splash-container" class="flex-container is-size-4">
  <div id="top-container" class="flex-item">
    <div id="up-next" class="has-text-warning">
      <p id="up-next-top" style="margin-bottom: 5px"></p>
      <p id="up-next-bottom" class="has-text-success has-text-right"></p>
    </div>
  </div>

  <div class="flex-item">
    <div class="logo-container">
      <img class="logo" src="{{ url_for('logo') }}" width="500px" alt="logo" />
    </div>
  </div>

  <div id="bottom-container" class="flex-item">
    <img
      src="{{ url_for('qrcode') }}"
      width="100px"
      style="image-rendering: pixelated"
      alt="qrcode"
    />
    <span class="is-size-4">&nbsp;Connect at: {{ url }}</span>
  </div>
</div>

<div id="video-container" class="video-container">
  <video id="video" width="100%" height="100%">
    <source id="video-source" type="video/mp4" src="" />
  </video>
</div>

<div id="permissions-modal" class="modal is-active">
  <div class="modal-background"></div>
  <div class="modal-content">
    <p>
      {# MSG: Prompt for interaction in order to enable video autoplay. #} {%
      trans %}Due to limititations with browser permissions, you must interact
      with the page once before it allows autoplay of videos. Pikaraoke will not
      play otherwise. Click the button below to confirm.{% endtrans %}
    </p>
    <div class="has-text-centered">
      <button
        id="permissions-button"
        class="button is-success"
        style="margin-top: 10px"
        onClick="handleConfirmation()"
      >
        Confirm
      </button>
    </div>
  </div>
</div>

<style>
  html {
    overflow-y: hidden;
  }
  body {
    background-color: black;
  }
  #splash-container {
    position: relative;
    top: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1;
  }
  .flex-container {
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
    justify-content: flex-start;
    align-content: stretch;
    align-items: flex-start;
    height: 100vh;
  }
  .flex-item {
    padding: 10px 20px;
  }
  #top-container,
  #bottom-container {
    min-height: 100px;
  }
  .flex-item:nth-child(1) {
    flex: 0 1 auto;
    align-self: flex-end;
  }
  .flex-item:nth-child(2) {
    flex: 1 1 auto;
    align-self: center;
    justify-content: center;
  }
  .flex-item:nth-child(3) {
    flex: 0 1 auto;
    align-self: auto;
  }
  .video-container {
    position: absolute;
    z-index: 2;
    top: 0;
    width: 100vw;
    height: 100vh;
    background-color: black;
    display: flex;
    align-items: center;
  }
  body {
    background-color: black;
  }
  .logo-container {
    display: flex;
    width: 100%;
    height: 100%;
    align-items: center;
    justify-content: center;
  }
</style>

{% endblock %}
