{% extends 'base.html' %}

{% block scripts %}
<link href="{{  url_for('static', filename='selectize.min.css') }}" rel="stylesheet" />
<script src="{{  url_for('static', filename='selectize.min.js') }}"></script>
<style>
  .optgroup-header {
    font-weight: bold;
  }

  .row {
    display: flex;
    /* equal height of the children */
    border-bottom: 1px solid #cccccc;
  }

  .col-icon {
    padding-left: 1px;
  }

  .col-text {
    padding-left: 2px;
    font-size: 120%;
  }

  #youtube-link {
    font-size: 80%;
  }

  .selectize-input {
    height: 37px;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
  }
</style>
<script>
  $(function () {
    $("#search_result_selector").focus();

    $("#search-link").click(function () {
      //$(".overlay").show();
      if (!$("#search-link").is('[disabled=disabled]')) {
        $("#search-link").addClass("is-loading");
      }
    });

    $("#download-button").click(function () {
      //$(".overlay").show();
      if (!$("#download-button").is('[disabled=disabled]')) {
        $("#download-button").addClass("is-loading");
      }
    });

    $("#add-queue-link").click(function () {
      //$(".overlay").show();
      $("#add-queue-link").addClass("is-loading");
    });


    //START SELECTIZE CHANGES

    //if enter key press, by default search button is click
    $(document).keypress(
      function (event) {
        if (event.which == '13') {
          event.preventDefault();

          if ($(".search-selectize .selectize-input input").val()) {
            $('#search-link').trigger("click");
          }
          else if ($('.search-selectize').find(":selected").text()) {
            $('#add-queue-link').trigger("click");
          }
        }
      });

    $("#add-queue-link").hide();
    $("#add-queue-link").attr("disabled", "true");
    $("#search-link").attr("disabled", "true");
    var $select = $('.search-selectize').selectize({
      createOnBlur: true,
      openOnFocus: false,
      createFilter: function (input) { return input.length >= 2; },
      onInitialize: function () {
        var that = this;

        this.$control.on("click", function () {
          that.ignoreFocusOpen = true;
          setTimeout(function () {
            that.ignoreFocusOpen = false;
          }, 50);
        });
      },

      onFocus: function () {
        if (!this.ignoreFocusOpen) {
          this.open();
        }
      },
      onBlur: function () {
        this.setTextboxValue(this.currentResults.query);
      },
      onChange: function (id) {
        if (!id) {
          $("#add-queue-link").attr("disabled", "true");
          $("#search-link").attr("disabled", "true");
          $("#add-queue-link").hide();
          $("#search-link").show();
        } else {
          $("#add-queue-link").removeAttr("disabled");
          $("#search-link").removeAttr("disabled");
          $("#add-queue-link").show();
          $("#search-link").hide();
        }
      },
      onType: function (text) {
        if (!text) {
          $("#search-link").attr("disabled", "true");
          $("#add-queue-link").show();
          $("#search-link").hide();
        }
        else {
          $("#search-link").removeAttr("disabled");
          $("#add-queue-link").hide();
          $("#search-link").show();
        }
      },
      render: {
        option: function (item, escape) {
          return '<div class="row">'
            + '<div class="col-icon"><i class="icon icon-music has-text-info"></i></div>'
            + '<div class="col-text">' + item.text + '</div>'
            + '</div>';
        },
        optgroup_header: function (data, escape) {
          return '<div class="optgroup-header has-text-info">' + escape(data.label) + '</div>';
        }
      },
    });

    $('#search-link').on('click', function (e) {
      e.preventDefault();
      var search_term = $(".search-selectize .selectize-input input").val();
      console.log("search term: " + search_term)
      var include_non_karaoke = $("#include-non-karaoke").is(":checked")
      if (search_term) {
        $('#searching_loader').removeClass("is-hidden");
        $('#searching_loader #search_term').text(search_term);
        $('#search-link').attr("disabled", "true");
        $('#search_string').val(search_term);
        $('#non_karaoke').val(include_non_karaoke);
        $('#container_search_result').hide();
        $('#container_search_form form').submit();
      }
    });
    $('#add-queue-link').on('click', function (e) {
      e.preventDefault();
      console.log($('.search-selectize').find(":selected").text())
      if ($('.search-selectize').find(":selected").text()) {
        $('#add-queue-link').attr("disabled", "true");
        $('#container_queue_form form').submit();
      }
    });
    //END SELECTIZE CHANGES

    $('#youtube-link').attr('href', $('#search_result_selector').val());
    $('#youtube-link').text($('#search_result_selector').val());

    //get youtube thumbnail based on ID
    i = -1;
    changeImage();


    $(document).on('change', '#search_result_selector', function () {
      var url = $('#search_result_selector').val();
      $('#youtube-link').attr('href', url);
      $('#youtube-link').text(url);
      changeImage();
    });
    //alow click of images
    $('#youtube-thumb').click(function (e) {
      changeImage();
    });
    setInterval(function () { $('#youtube-thumb').trigger('click'); }, 2000);

    $('#advanced-settings').hide()

    // handle show advanced state
    $('#show-advanced').on('change', function () {
      if ($('#show-advanced').is(":checked")) {
        $('#advanced-settings').show()
      }
      else {
        $('#advanced-settings').hide()
      }
    });

    // handle direct download url input change
    $('#direct-download-url').on('input', function () { 
      var v = $('#direct-download-url').val()
      console.log(v)
      if (isYoutubeURL(v)) {
        $('#direct-download-button').removeAttr("disabled")
      }
      else {
        $('#direct-download-button').attr("disabled", true)
      }
    });
    
  });
    
  function isYoutubeURL(s) {
    if (s.includes("http")) {
      return s.includes("youtube.com/watch?v=") || s.includes("youtube.com/v/") || s.includes("youtu.be/")
    }
    else {
      return false
    }
  }

  function changeImage() {
    var next = (++i % 4);
    var youtube_id = $('#search_result_selector').find(':selected').data('ytid');
    var fn = (next == 0) ? "default" : next;
    var img_src = 'https://img.youtube.com/vi/' + youtube_id + '/mq' + fn + '.jpg'
    $('#youtube-thumb').attr("src", img_src);
  }  
</script>
{% endblock %}

{% block header %}
<h1>{% block title %}Search{% endblock %}</h1>
{% endblock %}

{% block content %}

<div class="field" id="container_queue_form">
  <form action="{{ url_for('enqueue') }}" method="post">
    <div class="field has-addons" style="margin-bottom: 5px">
      <div class="control" style="width:100%">
        <select class="search-selectize" name="song_to_add">
          <option value=''></option>
          <optgroup label="Available Songs" id="available-songs">
            {% for file in songs %}
            <option value='{{file}}'>{{ filename_from_path(file) }}</option>
            {% endfor %}
          </optgroup>
        </select>
      </div>
      <div class="control">
        <a class="button is-warning" id="search-link">Search</a>
        <a class="button is-info" id="add-queue-link">Queue</a>
      </div>
    
    </div>
    <div class="control has-text-right">
      
      <label class="checkbox is-size-7">
        <input type="checkbox" id="show-advanced" name="show-advanced">
        Advanced
      </label>
    </div>
    
    <div>
      <p class="help" style="margin-top: 15px">
        Type a song (title/artist) to search the available songs and click 'Queue' to add it to the queue.
      </p> 
      <p class="help">
        If the song doesn't appear in the "Available Songs" dropdown, click 'Search' to find it on Youtube
      </p>
    </div>
  </form>
</div>

<div>
  <div id="advanced-settings" class="box has-background-black-bis" style="margin-top: 10px">
    <div class="control">
      <label class="checkbox">
        <input type="checkbox" id="include-non-karaoke" name="include-non-karaoke">
        Include non-karaoke matches
      </label>
    </div>
    <hr>
    <div class="control">
      <div class="label">Direct download YouTube url: </div>
      <form  action="{{ url_for('download') }}" method="post">
        <input class="input" id="direct-download-url" type="text" name="song-url" />
        <div class="field" style="margin-top: 5px">
          <label class="checkbox">
            <input type="checkbox" checked name="queue">
            Add to queue
          </label>
        </div>
        <div class="has-text-right" style="margin-top: 5px">
          <button class="button is-small is-rounded" disabled id="direct-download-button" type="submit">Download</button>
        </div>
      </form>
    </div>
  </div>
</div>

<hr>

<div class="field is-hidden" id="container_search_form">
  <form action="{{ url_for('search') }}" method="get">
    <input id="search_string" type="text" name='search_string' />
    <input type="text" id="non_karaoke" name="non_karaoke" />
  </form>
</div>

<div id="searching_loader" class="control is-loading is-hidden">Searching <small><i>'<span
        id="search_term"></span>'</i></small></div>
{% if search_results %}
<div class="field" id="container_search_result">
  <form action="{{ url_for('download') }}" method="post">
    <label class="label">Search Results for <small><i>'{{search_string}}'</i></small></label>
    <div class="field select">
      <select id="search_result_selector" name='song-url'>>
        {% for title,url,id in search_results %}
        <option data-ytID='{{id}}' value='{{url}}'>{{title}}</option>
        {% endfor %}
      </select>
    </div>

    <p class="help">Click dropdown to show more results</p>

    <p> Link: <a target="_blank" id='youtube-link' href=''></a> </p>
    <p> <img id='youtube-thumb'> </p>
    <div class="field">
      <label class="checkbox">
        <input type="checkbox" checked name="queue">
        Add to queue
      </label>
    </div>
    <div class="field">
      <button class="button is-success is-medium" id="download-button" type="submit">Download</button>
    </div>
  </form>
</div>
{% else %}
{% endif %}

{% endblock %}